<html>
<br>I have stopped making music for a little while, and have instead been writing a program to play the abstract strategic board game "<a contents="Pente" data-link-label="" data-link-type="url" href="http://en.wikipedia.org/wiki/Pente" target="_blank">Pente</a>".<br><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/1d75297192cc88b4cdbabb55810f06e0d5ed0ef4/original/screen-shot-2014-03-24-at-11-08-30-pm.png?1395663102" class="size_l justify_center border_" /><br>I find this game to be a perfect fit for my requirements for a game: it is quick to learn (&lt; 5m), quick to play (~ 5m), and there is no luck involved, but it takes many games to learn how to play well. You can find out lots of information about Pente on the net, e.g. on <a contents="wikipedia" data-link-label="" data-link-type="" href="http://en.wikipedia.org/wiki/Pente">wikipedia</a>. This page is about how my computer program PentAI is constructed.</span><br> <hr><span class="font_large"><span class="font_xl"><strong>Artificial Intelligence</strong></span><br><strong>Position representation</strong><br>The board occupancies are stored as four arrays of integers,<br>one array per direction (E, SE, S, NE). Each number in the arrays represents a line across the board in that direction, and the pieces on it. Two bits are used per location, with 0 representing empty, 1 Black (Player 1), 2 White (P2), and 3 is unused. This allows for rapid pattern matching for lines, captures, threats and closed 4s in any direction, using bitwise operations such as AND, OR, XOR and shift.<br><br><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/12e726d09ff2bcebd1a849dc376063a00db75b40/original/pentai-board.png?1394320990" class="size_l justify_center border_" /><br>This position would be represented in memory as:<br>E: [0, 0, 0, 0, 2048, 1024, 6160, 0, 0, 0, 0, 0, 0]</span>
<p class="p1"><span class="font_large">SE: [0, 0, 0, 0, 0, 0, 0, 0, 16, 2048, 1024, 2048, 4096, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</span></p>
<p class="p1"><span class="font_large">S: [0, 0, 4096, 0, 0, 9728, 4096, 0, 0, 0, 0, 0, 0]</span></p>
<p class="p1"><span class="font_large">NE: [0, 0, 0, 0, 0, 0, 0, 0, 16, 0, 0, 2048, 5120, 2048, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]<br><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/b512b56c2391f0df2089775bd4e8eb28390d244a/medium/compass.png?1394348023" class="size_m justify_center border_" /></span></p><span class="font_large">For instance, the 2048 in the East representation is for the white piece in the fifth row up - each number represents a whole line in that direction (horizontal row in this case). 2048 represents the presence </span><span style="font-size: 1.4em;">of a white piece in the 6th column, with nothing else in that row:</span><br><span class="font_large">4<sup>(6-1)</sup> x 2 = 2048</span><br><span class="font_large">i.e. 2 x zero bits for each of the 5 empty points to its left, and another bit for the white coloured stone.<br>Or in base 4 it would be 200000.<br><br>The numbers in the arrays start from the SW corner going up (N) for the E and SE arrays, from the NW corner going right (E) for the S array, and from the NW corner going down (S) for the NE array.<br><br>For a 19x19 board, that means the space used is:</span><br><span class="font_large">2 x 19 x 64 bits (horiz &amp; vert) = 2432<br>2 x 37 x 64 bits (for the diags) = 4736<br>+ a couple of bytes for capture counts and programming language overheads.<br>= Around 900 bytes per position.<br>However, the amount of space used per position is generally not a big deal, because the search is done depth-first, and the transposition table (described below) only uses one representation out of the four.</span><br><br><span class="font_large"><strong>Pattern Matching</strong><br>All pattern matching is currently done in 1d only. Capture and threat moves are detected using bitwise operations on a number representing a line as described above. Each pattern is represented as a number that is pre-calculated. For instance, the pattern number for capturing a pair to the left of the move position x is:<br>B W W x     (1 x 1  +  2 x 4  +  2  x 16  +  0 x 64) = 41, or in base 4: 0221<br>The first numbers in each multiplication are 1 for B or 2 for W; the second numbers are powers of 4.<br>Whenever Black moves, the bits for the 4 locations up to and including the move position can be matched against this pattern number to check if it causes a black capture to the left of the move.</span>
<p><strong style="font-size: 1.4em;">Line Counts</strong></p><span class="font_large">There is another type of data that is used extensively by the AI player - potential line length counts.<br>The AI player counts the potential 5 in a row stretches per location, with the number of already occupied locations out of each line.<br><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/5e0f3d5cb7f06b5cd04b3c20c029258dec21340d/medium/line-counts.png?1394349154" class="size_m justify_left border_none" alt="" /><br><br>At the moment, there are several potential fives that can be extended by white playing at x.<br>Starting with the left 5, these have a current count of:<br>   2  3  3  2  1<br>(the one represents the stretch from x to the right edge)<br><br>If white placed a stone at x, it would look like this:<br><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/d3c1396b104682f3f70df16a6b76d77b164fd276/medium/line-counts-2.png?1394349824" class="size_m justify_left border_none" alt="" /><br><br>and the counts would be:<br>  3  4  4  3  2<br><br>These counts are used for two things: to suggest locations as candidate moves, and to contribute to a utility value for each position.<br><br>Since this data is required for every position in the search tree, it is maintained incrementally; every time a stone is placed on the board or taken off, these counts are adjusted.<br><br><strong>Symmetry</strong><br>There are 8 equivalent positions for every position, from rotations or a whole board flip.</span>
<table border="0" cellpadding="0" cellspacing="30"><tbody>    <tr>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/d6096677ed4f69b7da4ddd014372f292338f54f0/large/rh.jpg?1394343287" class="size_xl justify_center border_" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/59dea2ecb909d8165c30ca3ad6565102852a794a/large/rh2.jpg?1394343289" class="size_xl justify_center border_none" alt="" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/56dad8b28a896d67ecb4382f42e205c8a7b7ec0c/large/rh3.jpg?1394343288" class="size_xl justify_center border_none" alt="" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/9bada5760a77e86c2c873bc30e62e19d4a6f3d1d/large/rh4.jpg?1394343288" class="size_xl justify_center border_none" alt="" /></td>    </tr>    <tr>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/cc37636e8c5b6aaf8978390a6812ade6be3df4d5/large/lh1.jpg?1394343318" class="size_xl justify_center border_none" alt="" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/c25ebe67a8e800dc510b27587b184dfc2744f851/large/lh2.jpg?1394343318" class="size_xl justify_center border_none" alt="" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/4f98a2cb61ad10ae44042ca0ed2d0788f4518599/large/lh3.jpg?1394343320" class="size_xl justify_center border_none" alt="" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/7cac23d7b36ecd983d030daeb37e4017e322bc45/large/lh4.jpg?1394343322" class="size_xl justify_center border_none" alt="" /></td>    </tr>
</tbody></table><br><span class="font_large">PentAI exploits this in its "Openings Book". It does this by matching a "canonical form" of the current game position against a hash table of canonical forms of previously played game positions. By <a contents="canonical form" data-link-label="" data-link-type="url" href="http://en.wikipedia.org/wiki/Canonical_form" target="_blank">canonical form</a>, I mean a representation of the game position that is unique to all symmetrical equivalents of that position.<br><br>For PentAI, I chose to use the minimum East array representation. To find the canonical representation, I iterate through the symmetrical equivalents by using a couple of flipping operations - a flip along the NE diagonal by swapping the E and S lines, and a left to right flip by reversing the order of the S array and reversing the order of the 2 bit sections of each of the numbers in the E array.<br><br>For example, assume that the current position is as above:<br>E: [0, 0, 0, 0, 2048, 1024, 6160, 0, 0, 0, 0, 0, 0]</span><br><span style="font-size: 1.4em;">S: [0, 0, 4096, 0, 0, 9728, 4096, 0, 0, 0, 0, 0, 0]</span><br><br><span class="font_large">(diagonal representations aren't required for canonisation because no amount of these flipping operations will get them into the E array)<br><br>Then after a NE diagonal flip, we would have:<br><br>E: [0, 0, 4096, 0, 0, 9728, 4096, 0, 0, 0, 0, 0, 0]</span><br><span class="font_large">S: [0, 0, 0, 0, 2048, 1024, 6160, 0, 0, 0, 0, 0, 0]</span>
<p class="p1"><br><span style="font-size: 1.4em;"><em>OR </em>after a L/R (= E/W) flip, we would have:</span></p>
<div>
<p class="p1"><span class="font_large">E: [0,</span><span style="font-size: 1.4em;">0,</span><span class="font_large">0,</span><span class="font_large">0,</span><span class="font_large">1048576,</span><span class="font_large">2097152,</span><span style="font-size: 1.4em;">135790592,</span><span class="font_large">0,</span><span class="font_large">0,</span><span class="font_large">0,</span><span class="font_large">0,</span><span class="font_large">0,</span><span style="font-size: 1.4em;">0]</span><br><span style="font-size: 1.4em;">S: [0, 0, 0, 0, 0, 0, 4096, 9728, 0, 0, 4096, 0, 0]</span><br> </p>
<p class="p1"><span style="font-size: 1.4em;">The minimum E representation out of these three would in this case be the original position (using Python's default array ordering):</span><br><span class="font_large">E: [0, 0, 0, 0, 2048, 1024, 6160, 0, 0, 0, 0, 0, 0]<br><br>(Although to calculate the real canonical representation for certain, you would need to compare all 8 symmetrical equivalents.)</span></p>
</div><strong><span class="font_large">Translational "Symmetry"</span></strong><br style="font-size: 16.66666603088379px;"><span style="font-size: 16.66666603088379px;">On a large (19x19) board, positions that are basically the same, just shifted slightly, left, right, up and/or down can be played as if they are the same. If there are any stones within 5 intersections of an edge in a given dimension, the board position is treated as not being movable in that dimension.<br>To implement this feature, the canonization routine just removes up to 5 leftmost and uppermost empty intersections.</span><br><br><span class="font_large"><strong>Openings Move Selection</strong><br>If the canonical position is in the Openings Book, it can be used to suggest a good move for the current player. There can be several games that have been played that match that position, with a number of wins and losses per move from that position, and ratings of the players per game. PentAI usually randomly selects one of these moves based on how many games were won or lost when that move was chosen. If the openings book doesn't suggest a move then it falls through to the normal deterministic search process. <br><br><strong>Automatic Learning</strong></span><br style="font-size: 16.66666603088379px;"><span class="font_large">Every game is automatically added to the openings book when it is completed. In this way, PentAI may appear to get smarter the more you play against it (though very slowly)</span><br style="font-size: 16.66666603088379px;"><br><span class="font_large"><strong>Deterministic Search</strong><br>PentAI searches the game tree for a fixed number of moves, currently with a maximum of 10 levels of depth. For each position, it searches a maximum of 9 alternatives. Leaf nodes of the search are evaluated and given a score which represents how good a position it is from the perspective of the player who is doing the search.<br><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/69e7a417abe6cba7ca13274108f1329ac7247b21/large/tree.gif?1394410048" class="size_xl justify_center border_none" alt="" /><br>These values are bubbled up back to the top level of the search, and the best (of the worst of the best of the worst etc...) is chosen. The</span> <a contents="Alpha Beta algorithm" data-link-label="" data-link-type="url" href="http://en.wikipedia.org/wiki/Alpha%E2%80%93beta_pruning" style="font-size: 16.6666660308838px;" target="_blank">Alpha Beta algorithm</a><span style="font-size: 16.6666660308838px;"> is used t</span><span class="font_large">o reduce the size of the tree searched, without altering the result.</span><br><span class="font_large">The width of the search is 9 alternatives for the top 3 levels of the search, then it is constrained to 5 alternatives per move for subsequent levels; this seems to give a good balance between playing strength and speed.<br><br><strong>Candidate Moves</strong><br>If every possible move was tried at every level of the search, the size of the game tree would blow out enormously, and we would only be able to search a couple of levels deep. For this reason, we need to reduce the number of moves, and only search those that are likely to be the best. Candidates are chosen from the "Line Counts" data described above, sorted from longest to shortest. This candidate selection is done for every position in the search tree except leaf nodes, for which a utility value is calculated.<br><br>The priority levels are as follows (with examples):</span>
<table border="0" cellpadding="10" cellspacing="1"><tbody>    <tr>        <td> </td>        <td style="text-align: center;"><span class="font_large">Us</span></td>        <td style="text-align: center;"><span class="font_large">Them</span></td>    </tr>    <tr>        <td><span class="font_large">4 out of 5</span></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/70c22cf217c6440e6a46fa54ae94daf196972026/large/4a.png?1394428225" class="size_xl justify_center border_none" alt="" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/137362d3e062dd3a63391ffa65cb6a03cf797e08/large/4w.png?1394536577" class="size_xl justify_center border_" /></td>    </tr>    <tr>        <td><span class="font_large">Capture</span></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/f97d7fc3a63731008a7eac667a3dab39223c8590/large/cap-b.png?1394434785" class="size_xl justify_center border_" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/21c8806a256a011e5a12a71b5667023c023d29df/large/cap-w.png?1394434788" class="size_xl justify_center border_" /></td>    </tr>    <tr>        <td><span class="font_large">3 out of 5</span></td>        <td><span class="font_large"><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/852990b209205eb2b4b02c3667154d06c16c2866/large/3a.png?1394428810" class="size_xl justify_center border_none" alt="" /></span></td>        <td><span class="font_large"><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/b32a26dc79054a2d78ad153b744bc6a2ddc1f62e/large/3w.png?1394536577" class="size_xl justify_center border_" /></span></td>    </tr>    <tr>        <td><span class="font_large">Threaten</span></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/018a89ba46aa182a7bbf756f9db932a21289c0ae/large/threat-b.png?1394434788" class="size_xl justify_center border_" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/e5dc1875ed2ecd04f0e00bf3fdd54bbc6b50aa5d/large/threat-w.png?1394434787" class="size_xl justify_center border_none" alt="" /></td>    </tr>    <tr>        <td><span class="font_large">2 out of 5</span></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/6bc48da8b87f7d82c3cb05f3cfa91432b7b123f6/large/2b.png?1394428221" class="size_xl justify_center border_none" alt="" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/f0b0413aece6dc9433835de5d8f6eaaeda4d6814/large/2w.png?1394536579" class="size_xl justify_center border_" /></td>    </tr>    <tr>        <td><span class="font_large">1 out of 5</span></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/be37b341f15015509b07ad3f361fd56da6de4966/large/1b.png?1394428220" class="size_xl justify_center border_none" alt="" /></td>        <td><img src="http://s3.amazonaws.com/content.sitezoogle.com/u/79199/16b2632f1affd4e6deb3d55b720c484fe3999499/large/1w.png?1394536578" class="size_xl justify_center border_" /></td>    </tr>
</tbody></table><br><span class="font_large">This table should be read like a book: L-&gt;R, then down - For each of these levels, moves for the player whose turn it is ("Us") at this level of the search are given a higher priority than those for the opponent ("Them"), since in Pente, "Attack is the best Defence". The Xs mark a candidate move.<br><br>For example:<br>If it is black's turn, and one possibility is to extend a line of three, and another is to capture a pair, the capture will be searched first.<br><br>Another example:<br>If it is black's turn, and one possibility is to place a stone in a place that blocks a white three, and another possibility is to extend a black line of two, it will search the former first.<br><br>Note that the table is showing only horizontal examples - vertical and diagonals are given equal priorities to their horizontal cousins.<br><br><strong>Utility Score</strong><br>Positions are each given a value so they can be compared for relative desirability. The inputs for the utility score calculation are the number of captures by each player, and the total numbers of potential fives of each current length as described above. The longer current length lines contribute exponentially more than the shorter ones. The value of captures also increases with more captures to represent the increased likelihood of a win.<br>Positions that are won or lost are given a score of positive or negative infinity respectively, and don't need to be searched further.</span><br><br><strong style="font-size: 16.6666660308838px;">Enclosed fours</strong><br style="font-size: 16.6666660308838px;"><span style="font-size: 16.6666660308838px;">A line of four in a row that is blocked at both ends is often advantageous for that player, because if one of the blocking stones is captured, it becomes a half-open four, which must usually be answered immediately by the opponent. Enclosed fours are used by the utility calculator, but not by the candidate move selection.</span><br><br><span class="font_large"><strong>Transposition table</strong><br>Further into the game, symmetries of previously reached positions become rarer. However, the same position can easily occur in a different part of the game tree, due to a different ordering of the same moves.<br>For example, the position reached after:</span>
<p class="p1"><span style="font-size: 1.4em;">K10, L9, N10, L13 is identical to that after:</span></p>
<p class="p1"><span class="font_large">K10, L13, N10, L9</span></p>
<p class="p1"><span class="font_large">So in my understanding, that isn't a type of symmetry, it is exactly the same position; this is where a transposition table is handy.</span></p><span class="font_large">To avoid having to evaluate that position or subtree again, every position is stored in a <a contents="Transposition Table" data-link-label="" data-link-type="url" href="http://en.wikipedia.org/wiki/Transposition_table" target="_blank">Transposition Table</a> (just a python dict == hash table).</span>  <span class="font_large">A single representation of the position is sufficient to use as a key, so the East strips are used. As each position is given a utility value, it is added to the transposition table. The value stored is the previously calculated utility score of that position.<br><br>Later when a position is searched, the first thing it does is to see if that position appears in the transposition table, and if so, use the utility value that was stored for that position. Note that before each move, the transposition table has to cleared to allow deeper search values to replace those found earlier.</span><br><br><span class="font_large"><strong>Tuning</strong><br>To find some good values for various parameters, many competitions were set up between handcrafted versions of the AI player algorithms. Parameters that have been tuned include:</span>
<ul>    <li><span class="font_large">Relative value of lines and captures</span></li>    <li><span class="font_large">Scaling factor of line length</span></li>    <li><span class="font_large">Scaling factor of more captured pairs</span></li>    <li><span class="font_large">Width of the search at different depth levels</span></li>    <li><span class="font_large">Alternative algorithms for selecting and ordering candidate moves</span></li>    <li><span class="font_large">Importance of existing capture threats</span></li>    <li><span class="font_large">Importance of potential capture threats</span></li>    <li><span class="font_large">A few methods of calculating an overall score</span></li>
</ul><span class="font_large">A <a contents="Genetic Algorithm" data-link-label="" data-link-type="url" href="http://en.wikipedia.org/wiki/Genetic_algorithm" target="_blank">Genetic Algorithm</a> could be used to tune the parameters, but hasn't been so far.</span><br> <hr><span class="font_large"><span class="font_xl"><strong>Implementation</strong></span><br>PentAI is written in the <a contents="Python programming language" data-link-label="" data-link-type="url" href="http://www.python.org" target="_blank">Python programming language</a>. The user interface is written using the <a contents="Kivy library" data-link-label="" data-link-type="url" href="http://kivy.org/" target="_blank">Kivy library</a>, which provides platform independence between several mobile and standard computer platforms. (iOS, Android, OS X, Windows)<br><br><strong>Search Process</strong><br>The CPU intensive AI code is converted into C extension modules by <a contents="cython" data-link-label="" data-link-type="url" href="http://cython.org/" target="_blank">cython</a>.<br>To prevent the GUI from becoming unresponsive, the search is split into a separate process. This is currently spawned by the GUI each turn that a search is required, although it would be fairly easy to reuse the search process if that became necessary. On iOS, multithreading is used instead, as multiprocessing is not available.<br><br><strong>Persistence</strong><br>Most of the data storage is done using <u><a contents="ZODB" data-link-label="" data-link-type="url" href="http://www.zodb.org/" target="_blank">ZODB</a></u>. Sections for this format include those for Games, Players, and Openings Positions, and are equivalent to tables in a relational database, without having to jump through hoops to do object relational mapping. <br><br><strong>Settings</strong><br>For application wide settings, the PentAI program uses the standard python config module and the user interface is derived from the kivy settings module, though it is reimplemented.<br><br><strong>Sounds</strong><br>Most sound effects have four or more variants, and one is chosen randomly from them, except that the last sound in that category that was played is excluded.<br><br><strong>Playing badly</strong><br>Many people have suggested that it has to be able to play badly. Making this possible was MUCH easier than making it play well. It has been implemented by a couple of techniques:</span>
<ul>    <li><span class="font_large">Vision - a chosen percentage of candidate moves from every position are skipped.</span></li>    <li><span class="font_large">Judgement - every position evaluation is adjusted randomly; the lower the judgement value, the greater the randomness applied.</span></li>
</ul><span class="font_large">...or the user can simply reduce the search depth.<br><br><strong>Statistics</strong><br>Production python code size: 9327 </span><span class="font_large">lines<br>Production cython code size: 3875 lines</span><br><span class="font_large">Test code size: 8250 lines<br>Unit Tests: 455, which run in around 0.54s<br>AI subsystem tests: 12 which run in &lt;20s<br>Screens: 18<br>Transposition table hits: ~8%</span><br><span class="font_large">Positions/s: ~1200<br>Depth 10 move time: ~35s<br>Depth 6 move time: ~3s<br>(times are for my laptop version, iPad is much slower)<br><br>I hope that was interesting and useful. Let me know if you have any more questions.</span></section></div></td></tr></tbody></table>
</html>
